<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TruthGuard</title>
    <link rel="icon" href="/ico/Detect.ico">
    <link rel="stylesheet" href="/client-src/css/variables.css">
    <link rel="stylesheet" href="/client-src/css/common.css">
    <link rel="stylesheet" href="/client-src/css/mobile.css">
    <script>
        // Use early script to fix landing on sub-paths (Vite + base: '/' is now used, but we still prefer clean URLs)
        // 解决从历史记录或外部链接进入时带有路径后缀导致的资源加载(CSS)丢失及状态异常
        (function() {
            const path = window.location.pathname;
            // 只要不是标准的 /Mobile (忽略结尾斜杠)，则重定向回基点，保持状态一致
            if (path.includes('/Mobile/') && path.replace(/\/$/, '') !== '/Mobile') {
                window.location.replace('/Mobile');
            }
        })();
    </script>
    <script type="module" src="/client-src/js/theme-loader.js"></script>
    <script type="module" src="/client-src/js/mobile.js"></script>
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
</head>
<body>
    <!-- HEADER -->
    <header class="mobile-header">
        <!-- 历史记录按钮 (初始页左上角) -->
        <button id="historyBtn" class="icon-btn">
             <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
        </button>
        
        <div class="header-title" id="headerTitle" style="display: none;">检测结果</div>

        <!-- 退出结果按钮 (结果页左上角) -->
        <button id="exitResultBtn" class="exit-result-btn" style="display: none;">
             <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
        </button>

        <!-- 导出按钮 (结果页右上角) -->
        <button id="exportBtn" class="export-result-btn" style="display: none;">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"/></svg>
        </button>

        <!-- 用户按钮 (右上角) -->
        <div id="userBtn" class="icon-btn">
            <img id="topBarAvatar" src="" style="display:none; width: 100%; height: 100%; object-fit: cover;">
            <svg id="topBarUserIcon" viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
            </svg>
        </div>
    </header>

    <!-- Loading Toast Area -->
    <div id="loadingToast" class="loading-toast">
        <div class="toast-content">
            <div class="toast-spinner"></div>
            <span id="toastMessage">正在分析中...</span>
        </div>
    </div>

    <!-- MAIN CONTAINER -->
    <div class="mobile-container">
        
        <!-- === VIEW 1: INPUT === -->
        <div id="inputView" class="view-section active">
            
            <div style="flex: 1;" class="branding-spacer"></div> <!-- Spacer -->

            <!-- Branding on start page -->
            <div id="startBranding" class="start-branding">
                <div class="brand-name">TruthGuard</div>
                <div class="brand-sub">AI 虚假信息检测</div>
            </div>

            <!-- Input Card -->
            <div class="input-card" id="inputCard">
                <!-- 退出编辑按钮 (移动到卡片内部以统一布局) -->
                <button id="exitEditBtnInside" class="exit-edit-btn" style="display: none;"><svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
                
                <div class="input-area-wrapper" id="inputAreaWrapper">
                    <!-- 链接/文件提取组件容器 (顶部) -->
                    <div id="extractedContentArea" class="extracted-content-area" style="display: none; padding: 0;"></div>

                    <!-- Image Previews (顶部) -->
                    <div id="previewImages" class="preview-images" style="display: none;"></div>

                    <label for="textInput" class="sr-only">新闻内容</label>
                    <textarea id="textInput" class="mobile-input" placeholder="输入新闻内容..."></textarea>
                    
                    <!-- New Split Toolbars -->
                    <div class="toolbar-container">
                        <div id="wordCountCapsule" class="word-count-capsule bg-glass">
                            <div id="wordCountIndicator" class="word-indicator">0/10000</div>
                            <div class="toolbar-divider"></div>
                            <button class="toolbar-icon-btn" id="clearBtn" title="清空">
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M16 9v10H8V9h8m-1.5-6h-5l-1 1H5v2h14V4h-3.5l-1-1zM18 7H6v12c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7z"/></svg>
                            </button>
                        </div>
                        <button class="circle-btn-flat bg-glass" id="plusBtn" title="添加">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                        </button>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="progress-container" id="progressBarContainer">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
            </div>
            
            <!-- Large Detect Button at bottom -->
            <div class="bottom-action-area">
                <button class="large-detect-btn" id="detectBtn" disabled>
                    开始检测
                </button>
            </div>

        </div>

        <!-- === VIEW 2: RESULT === -->
        <div id="resultView" class="view-section">
             <div id="resultItem" style="display:none; width: 100%;">
                
                <!-- Score Card -->
                <div class="result-card">
                     <div class="summary-header">
                        <div class="score-circle-container" id="scoreCircleContainer">
                            <svg class="score-circle-svg" viewBox="0 0 100 100">
                                <circle class="score-circle-bg" cx="50" cy="50" r="45"></circle>
                                <circle class="score-circle-progress" id="scoreProgress" cx="50" cy="50" r="45"></circle>
                            </svg>
                            <div class="score-inner">
                                <div class="score-val" id="scoreValue">--%</div>
                            </div>
                        </div>
                        <div class="summary-text-content">
                             <div class="summary-val-text" id="summaryValText">--%</div>
                             <div class="summary-title-text" id="summaryTitleText">检测结果</div>
                             <div class="summary-desc-text" id="summaryDescText">AI正在分析中...</div>
                        </div>
                     </div>
                     
                     <div class="result-analysis" id="analysisContainer">
                          <div class="analysis-title" style="font-weight:600; margin-bottom:10px; border-left: 4px solid var(--primary-color); padding-left: 8px;">详细分析</div>
                     </div>
                </div>

                <!-- Content Card -->
                <div id="parsedContent" class="result-card" style="display:none;">
                     <h2 id="parsedTitle" style="font-size:18px; margin-bottom:10px;"></h2>
                     <div id="parsedImages" style="margin-bottom: 12px;"></div>
                     <div id="parsedText" class="parsed-text" style="font-size:16px; line-height:1.6;"></div>
                </div>
            </div>
        </div>

    </div>

    <!-- Modals -->
    <div id="actionSheetBackdrop" class="drawer-backdrop" ></div>
    <div id="actionSheet" class="drawer-panel" style="height:auto; bottom:0; top:auto; width:100%; max-width:100%; transform:translateY(100%); transition:transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); border-radius: 20px 20px 0 0; padding-bottom:30px; left:0;">
         <div id="actionSheetContent">
             <div style="padding:20px; text-align:center; border-bottom:1px solid var(--bg-tertiary); font-size:16px;" id="uploadImageBtn">添加图片</div>
             <div style="padding:20px; text-align:center; border-bottom:1px solid var(--bg-tertiary); font-size:16px;" id="uploadDocBtn">上传文档</div> 
         </div>
         <div id="closeActionSheetBtn" style="padding:20px; text-align:center; color:var(--text-secondary); font-size:16px; cursor:pointer;" >取消</div>
    </div>

    <!-- Export Action Sheet -->
    <div id="exportActionSheet" class="drawer-panel" style="height:auto; bottom:0; top:auto; width:100%; max-width:100%; transform:translateY(100%); transition:transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); border-radius: 20px 20px 0 0; padding-bottom:30px; left:0; z-index: 10001;">
        <div id="exportActionContent">
            <div style="padding:20px; text-align:center; border-bottom:1px solid var(--bg-tertiary); font-size:16px;" class="export-option" data-format="image">导出为图片</div>
            <div style="padding:20px; text-align:center; border-bottom:1px solid var(--bg-tertiary); font-size:16px;" class="export-option" data-format="pdf">导出为 PDF</div>
            <div style="padding:20px; text-align:center; border-bottom:1px solid var(--bg-tertiary); font-size:16px;" class="export-option" data-format="html">导出为 HTML</div>
        </div>
        <div id="closeExportActionSheetBtn" style="padding:20px; text-align:center; color:var(--text-secondary); font-size:16px; cursor:pointer;" >取消</div>
    </div>

    <div id="historyDrawerBackdrop" class="drawer-backdrop" style="display: none;" ></div>
    <div id="historyDrawer" class="drawer-panel">
         <div class="drawer-header" style="display: flex; justify-content: space-between; align-items: center;">
            <span>历史记录</span>
            <button id="themeToggleBtn" class="icon-btn" style="padding: 0; background: none; border: none; color: var(--text-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; width: 32px; height: 32px;">
                <svg id="themeIcon" viewBox="0 0 24 24" width="22" height="22" fill="currentColor">
                    <!-- Sun (Visible in Dark Mode) -->
                    <path class="sun-icon" d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.06-1.06z" />
                    <!-- Moon (Visible in Light Mode) -->
                    <path class="moon-icon" d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-3.03 0-5.5-2.47-5.5-5.5 0-1.82.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z" />
                </svg>
            </button>
         </div>
         <div class="history-search-container">
            <div style="position: relative; width: 100%;">
                <label for="historySearchInput" class="sr-only">搜索历史记录</label>
                <input type="text" id="historySearchInput" class="history-search-input" placeholder="搜索历史记录...">
                <button id="clearHistorySearch" class="search-clear-btn" style="display: none;">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>
         </div>
         <div class="history-list" id="historyList"></div>
    </div>

    <!-- Image Modal -->
    <div class="image-modal" id="imageModal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center; flex-direction: column;" >
        <span class="close-circle-btn" id="closeImageModalBtn" style="position: absolute; top: 20px; right: 20px; width: 36px; height: 36px; z-index: 10001; background: rgba(0,0,0,0.3) !important; color: white !important;"></span>
        <img id="modalImage" style="max-width: 95%; max-height: 85%; object-fit: contain; transition: transform 0.3s ease-out;">
    </div>

    <div id="customTooltip" class="custom-tooltip"></div>

    <!-- Conflict Modal -->
    <div id="conflictModal" class="drawer-backdrop" style="align-items: center; justify-content: center;">
        <div class="result-card" style="width: 85%; max-width: 320px; text-align: center; padding: 24px;">
            <div style="font-weight: 700; font-size: 18px; margin-bottom: 12px; color: var(--text-primary);">内容不能共存</div>
            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 24px; line-height: 1.5;">系统暂不支持同时检测文本链接与本地图片，请选择保留其中一项。</div>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button class="large-detect-btn" style="height: 48px; font-size: 15px;" id="keepLinkBtn">保留网页链接</button>
                <button class="large-detect-btn" style="height: 48px; font-size: 15px; background: var(--bg-tertiary); color: var(--text-primary); box-shadow: none;" id="keepImagesBtn">保留本地图片</button>
                <button style="border: none; background: none; color: var(--text-muted); padding: 10px; font-size: 14px;" id="closeConflictBtn">取消</button>
            </div>
        </div>
    </div>

    <!-- General Confirmation Modal -->
    <div id="confirmModal" class="drawer-backdrop" style="align-items: center; justify-content: center; z-index: 11000;">
        <div class="result-card" style="width: 85%; max-width: 300px; text-align: center; padding: 20px; border-radius: 20px;">
            <div id="confirmTitle" style="font-weight: 700; font-size: 17px; margin-bottom: 8px; color: var(--text-primary);">确认提示</div>
            <div id="confirmMessage" style="font-size: 14px; color: var(--text-secondary); margin-bottom: 20px; line-height: 1.6;">确定要执行此操作吗？</div>
            <div style="display: flex; gap: 12px;">
                <button class="large-detect-btn" style="height: 42px; font-size: 14px; background: var(--bg-tertiary); color: var(--text-primary); box-shadow: none; flex: 1;" id="closeConfirmBtn">取消</button>
                <button id="confirmExecuteBtn" class="large-detect-btn" style="height: 42px; font-size: 14px; flex: 1;">确定</button>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" multiple accept="image/*,.heic,.heif" style="display: none;">
    <input type="file" id="docInput" accept=".doc,.docx,.pdf,.txt,.md,.jpg,.jpeg,.png,.webp,.heic,.heif" style="display: none;">
</body>
</html>